---
import type { ImageMetadata } from "astro";
import Seo from "../components/seo/Seo.astro";
import Toast from "../components/ui/Toast/Toast.astro";
import { getSiteSettings } from "../lib/sanity/sanity";
import type { SiteSettings } from "../lib/sanity/sanity.types";
import "../styles/global.css";

export interface Props {
  title?: string | undefined;
  description?: string | undefined;
  ogImage?: string | undefined;
  ogType?: "website" | "article" | "profile" | undefined;
  jsonLd?: string | undefined;
  canonicalUrl?: string | undefined;
  noindex?: boolean | undefined;
  preloadHeroImage?: ImageMetadata | string | undefined;
}

const {
  title,
  description,
  ogImage,
  ogType = "website",
  jsonLd,
  canonicalUrl,
  noindex = false,
  preloadHeroImage,
} = Astro.props;

let siteSettings: SiteSettings | null = null;
try {
  siteSettings = await getSiteSettings();
} catch (fetchError) {
  console.error("Sanity site settings fetch failed:", fetchError);
}

const defaultTitle = siteSettings?.defaultTitle || "Johander Campos | Software Engineer";
const titleTemplate = siteSettings?.titleTemplate || "%s | Johander Campos";
const resolvedTitle = title
  ? titleTemplate.includes("%s") && !title.includes("|")
    ? titleTemplate.replace("%s", title)
    : title
  : defaultTitle;
const resolvedDescription =
  description ||
  siteSettings?.defaultDescription ||
  "Front End Developer skilled in creating responsive, interactive web designs using HTML, CSS, JavaScript, and React.";
const resolvedOgImage = ogImage || siteSettings?.defaultOgImageUrl || "/images/thumbnail-preview.webp";
const resolvedSiteName = siteSettings?.siteName || "Johander Campos";
const resolvedSiteUrl = siteSettings?.siteUrl || Astro.site?.href || "https://developer.johandercampos.com";
---

<!doctype html>
<html lang="en">
  <head>
    <Seo
      title={resolvedTitle}
      description={resolvedDescription}
      image={resolvedOgImage}
      type={ogType}
      jsonLd={jsonLd}
      canonicalUrl={canonicalUrl}
      noindex={noindex}
      preloadHeroImage={preloadHeroImage}
      siteName={resolvedSiteName}
      siteUrl={resolvedSiteUrl}
    />
  </head>

  <body>
    <Toast />

    <div class="bg-noise" aria-hidden="true"></div>
    <div class="bg-topology" aria-hidden="true"></div>

    <slot />

    <script>
      const reveal = () => {
        const reveals = document.querySelectorAll(".reveal");

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("active");
                observer.unobserve(entry.target);
              }
            });
          },
          {
            threshold: 0.1,
            rootMargin: "0px 0px -50px 0px",
          },
        );

        reveals.forEach((el) => observer.observe(el));
      };

      reveal();
      document.addEventListener("astro:after-swap", reveal);
    </script>
  </body>
</html>
<script
  is:inline
  define:vars={{
    title: resolvedTitle,
    description: resolvedDescription,
    ogImage: resolvedOgImage,
    ogType,
    jsonLd,
    canonicalUrl,
    noindex,
    preloadHeroImage,
  }}
>
  // Ensure variables are "used" for static analysis
  console.debug("BaseLayout initialized");
</script>
