---
import BlogPostPage from "../../components/pages/BlogPostPage.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getBlogPost, getBlogPosts, urlFor } from "../../lib/sanity/sanity";
import type { BlogPost, BlogPostDetail } from "../../lib/sanity/sanity.types";
import { getBlogPostSchema, SITE_URL } from "../../components/seo/sanity-seo";

const { post: staticPost } = Astro.props;
const { slug: blogPostSlug } = Astro.params;

export async function getStaticPaths() {
	const posts = await getBlogPosts();
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

let currentBlogPost: BlogPost | BlogPostDetail | null = staticPost;

if (!currentBlogPost) {
	try {
		currentBlogPost = await getBlogPost(blogPostSlug!);
	} catch (fetchError) {
		console.error(
			"Sanity fetch failed for slug:",
			blogPostSlug,
			fetchError,
		);
	}
}

if (!currentBlogPost) {
	return Astro.redirect("/404");
}

const blogPostCoverImageUrl = currentBlogPost.coverImage
	? urlFor(currentBlogPost.coverImage).width(1200).height(630).url()
	: `${SITE_URL}/favicon.webp`;

const blogPostJsonLd = getBlogPostSchema(currentBlogPost);
---

<BaseLayout
	title={currentBlogPost.title}
	description={currentBlogPost.excerpt ||
		"Read this article by Johander Campos."}
	ogType="article"
	ogImage={blogPostCoverImageUrl}
	jsonLd={blogPostJsonLd}
>
	<BlogPostPage post={currentBlogPost} />
</BaseLayout>
