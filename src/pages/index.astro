---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/sections/Header.astro";
import ProjectCard from "../components/ui/cards/ProjectCard.astro";
import BlogCard from "../components/ui/cards/BlogCard.astro";
import Footer from "../components/sections/Footer.astro";
import photoImage from "../assets/images/portrait.webp";
import type { BlogPost, SkillCategory } from "../lib/sanity/sanity.types";
import { staticData } from "../data/staticData";
import { getHomeSchema } from "../lib/sanity/seo";
import { ContactForm } from "../components/sections/ContactForm.tsx";
import { FaqItem } from "../components/ui/FaqItem/FaqItem.tsx";
import { SkillCard } from "../components/ui/cards/SkillCard.tsx";
import {
  getPageContent,
  getFeaturedBlogPosts,
  getSkills,
} from "../lib/sanity/sanity";

let homePageContent = null;
let featuredBlogPosts: BlogPost[] = [];
let fetchedSkills: SkillCategory[] = [];

try {
  [homePageContent, featuredBlogPosts, fetchedSkills] = await Promise.all([
    getPageContent(),
    getFeaturedBlogPosts(),
    getSkills(),
  ]);
} catch (fetchError) {
  console.error("Sanity data fetch failed:", fetchError);
}

const skillCategories =
  fetchedSkills.length > 0
    ? fetchedSkills
    : (staticData.home.skills as unknown as SkillCategory[]);

const portfolioProjects =
  homePageContent?.projects?.map((sanityProject) => ({
    title: sanityProject.name,
    thumbnail: "https://placehold.co/600x400",
    technologies: sanityProject.techStack,
    demoUrl: sanityProject.demoUrl || "#",
    codeUrl: sanityProject.githubUrl || "#",
    category: sanityProject.category || "frontend",
  })) || [];

const PROJECT_CATEGORIES_ORDER = ["frontend", "backend", "fullstack"] as const;

const projectsByCategory = portfolioProjects.reduce(
  (groupedProjects, project) => {
    const projectCategory = project.category || "frontend";

    if (!groupedProjects[projectCategory]) {
      groupedProjects[projectCategory] = [];
    }

    groupedProjects[projectCategory].push(project);
    return groupedProjects;
  },
  {} as Record<string, typeof portfolioProjects>,
);

const frequentlyAskedQuestions = homePageContent?.faqs || [];

import { getImage } from "astro:assets";
const optimizedPersonImage = await getImage({
  src: photoImage,
  width: 375,
  height: 375,
  format: "webp",
});
const combinedJsonLd = getHomeSchema(
  homePageContent,
  staticData,
  optimizedPersonImage.src,
);
---

<BaseLayout
  title="Johander Campos | Front End Developer"
  description="Portfolio of Johander Campos, a Front End Developer specializing in React, TypeScript, and modern web technologies."
  jsonLd={combinedJsonLd}
  preloadHeroImage={photoImage}
>
  <Header
    name={staticData.basic.name}
    title={homePageContent?.hero?.title || staticData.basic.title}
    subtitle={homePageContent?.hero?.subtitle || staticData.basic.subtitle}
    paragraph={homePageContent?.hero?.bio || staticData.basic.bio}
    photo={homePageContent?.portrait && homePageContent.portrait.trim() !== ""
      ? homePageContent.portrait
      : photoImage}
    linkedinUrl={homePageContent?.socials?.linkedin ||
      staticData.basic.socials.linkedin}
    githubUrl={homePageContent?.socials?.github ||
      staticData.basic.socials.github}
    cvUrl={homePageContent?.cvUrl || "#"}
  />

  <main
    class="p-5 flex flex-col justify-center items-center text-text-base overflow-x-hidden transition-colors"
    id="main-content"
  >
    <section
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-[1.25rem] max-w-[50rem] w-full mb-16 lg:self-center"
      aria-labelledby="skills-heading"
    >
      <h2 id="skills-heading" class="sr-only">{staticData.home.skillsTitle}</h2>
      {
        skillCategories.map((cat: any, index: number) => {
          const skillsForTicker = [...cat.skills, cat.skills[0]];
          return (
            <div class={`reveal delay-${(index + 1) * 100}`}>
              <SkillCard
                client:visible
                category={cat.category}
                skills={skillsForTicker}
              />
            </div>
          );
        })
      }
    </section>

    {
      portfolioProjects.length > 0 && (
        <section
          class="flex flex-col justify-center items-center w-full max-w-[50rem] mb-16"
          aria-labelledby="projects-heading"
        >
          <div class="w-full mb-16 reveal">
            <h2
              id="projects-heading"
              class="text-[clamp(2.8rem,5vw,3.625rem)] font-display font-bold"
            >
              {staticData.home.projects.title}
            </h2>
            <p class="text-text-muted mt-2 font-sans">
              {staticData.home.projects.description}
            </p>
          </div>

          {PROJECT_CATEGORIES_ORDER.map((cat) => {
            const categoryProjects = projectsByCategory[cat] || [];
            if (categoryProjects.length === 0) return null;

            return (
              <div class="w-full mb-16 last:mb-0">
                <div class="flex items-center gap-4 mb-16 reveal">
                  <h3 class="text-2xl font-display font-bold capitalize text-text-base">
                    {cat}
                  </h3>
                  <div class="h-[1px] flex-1 bg-border-base/30" />
                  <span class="text-[10px] font-mono text-text-base font-bold uppercase tracking-[0.2em]">
                    {categoryProjects.length}{" "}
                    {categoryProjects.length === 1
                      ? staticData.home.projects.projectCount
                      : staticData.home.projects.projectsCount}
                  </span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-[1.5rem] w-full items-start">
                  {categoryProjects.map((project, index) => (
                    <article class={`reveal delay-${(index + 1) * 100} h-full`}>
                      <ProjectCard
                        title={project.title}
                        thumbnail={project.thumbnail}
                        technologies={project.technologies}
                        demoUrl={project.demoUrl}
                        codeUrl={project.codeUrl}
                      />
                    </article>
                  ))}
                </div>
              </div>
            );
          })}
        </section>
      )
    }

    {
      featuredBlogPosts.length > 0 && (
        <section
          class="flex flex-col justify-center items-center w-full max-w-[50rem] mb-16"
          aria-labelledby="blog-heading"
        >
          <div class="w-full flex justify-between items-center mb-16 reveal">
            <h2
              id="blog-heading"
              class="text-[clamp(2.8rem,5vw,3.625rem)] font-display font-bold text-left w-full"
            >
              {staticData.home.blog.title}
            </h2>
          </div>
          <div class="flex flex-col justify-center items-center gap-16 w-full">
            {featuredBlogPosts.map((post: BlogPost, index: number) => (
              <article class={`w-full reveal delay-${(index + 1) * 100}`}>
                <BlogCard
                  title={post.title}
                  excerpt={post.excerpt || ""}
                  slug={post.slug || ""}
                  coverImage="https://placehold.co/600x400"
                />
              </article>
            ))}
            <div class="reveal delay-300">
              <a
                href="/blog"
                class="font-bold hover:text-link-hover transition-all mt-4"
              >
                {staticData.home.blog.viewAll}
              </a>
            </div>
          </div>
        </section>
      )
    }

    <section class="w-full reveal mb-16" aria-labelledby="contact-heading">
      <h2 id="contact-heading" class="sr-only">Contact Me</h2>
      <ContactForm client:visible email="connect@johandercampos.com" />
    </section>

    {
      frequentlyAskedQuestions.length > 0 && (
        <section
          class="text-center p-2 sm:p-5 w-full md:max-w-[45rem] font-display mt-0 mb-16"
          aria-labelledby="faq-heading"
        >
          <div class="reveal">
            <h2
              id="faq-heading"
              class="text-[clamp(2.5rem,5vw,3.625rem)] font-bold tracking-[0.0625rem] sm:tracking-[0.125rem]"
            >
              {staticData.home.faq.title}
            </h2>
          </div>
          <div class="reveal">
            <div class="glassmorphism p-4 sm:p-[1.875rem] rounded-[1.25rem] sm:rounded-[1.875rem] mt-16 transition-all duration-300 cursor-pointer">
              {frequentlyAskedQuestions.map((faq) => (
                <FaqItem
                  client:visible
                  question={faq.question}
                  answer={faq.answer}
                />
              ))}
            </div>
          </div>
        </section>
      )
    }
  </main>

  <Footer
    linkedinUrl={homePageContent?.socials?.linkedin ||
      staticData.basic.socials.linkedin}
    githubUrl={homePageContent?.socials?.github ||
      staticData.basic.socials.github}
    repoUrl={staticData.basic.repoUrl}
  />
</BaseLayout>
