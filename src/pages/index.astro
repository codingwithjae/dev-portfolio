---
import { getImage } from "astro:assets";
import photoImage from "../assets/images/portrait.webp";
import { ContactForm } from "../components/sections/ContactForm";
import Footer from "../components/sections/Footer.astro";
import Header from "../components/sections/Header.astro";
import BlogCard from "../components/ui/cards/BlogCard.astro";
import ProjectCard from "../components/ui/cards/ProjectCard.astro";
import { SkillCard } from "../components/ui/cards/SkillCard";
import { FaqItem } from "../components/ui/FaqItem/FaqItem";
import { staticData } from "../data/staticData";
import BaseLayout from "../layouts/BaseLayout.astro";
import { getFeaturedBlogPosts, getPageContent } from "../lib/sanity/sanity";
import type { BlogPost, PageContent } from "../lib/sanity/sanity.types";
import { getHomeSchema } from "../components/seo/sanity-seo";
import {
  mapSanityProjectsToUI,
  groupProjectsByCategory,
  resolveSkillCategories,
  extractHomeSEO,
  extractAuthorHeader,
  PROJECT_CATEGORIES_ORDER,
  CATEGORY_DISPLAY_NAMES,
} from "../lib/sanity/transform";

let homePageContent: PageContent | null = null;
let featuredBlogPosts: BlogPost[] = [];

try {
  const [content, posts] = await Promise.all([
    getPageContent(),
    getFeaturedBlogPosts(),
  ]);
  homePageContent = content;
  featuredBlogPosts = posts;
} catch (fetchError) {
  console.error("Sanity data fetch failed:", fetchError);
}

const skillCategories = resolveSkillCategories(homePageContent);
const portfolioProjects = mapSanityProjectsToUI(homePageContent?.projects);
const projectsByCategory = groupProjectsByCategory(portfolioProjects);
const frequentlyAskedQuestions = staticData.home.faq.questions;

const optimizedPersonImage = await getImage({
  src: photoImage,
  width: 375,
  height: 375,
  format: "webp",
});

const {
  title: pageTitle,
  description: pageDescription,
  ogImage,
} = extractHomeSEO(homePageContent);
const headerData = extractAuthorHeader(homePageContent);

const combinedJsonLd = getHomeSchema(
  homePageContent,
  staticData,
  optimizedPersonImage.src,
);
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  ogImage={ogImage}
  jsonLd={combinedJsonLd}
  preloadHeroImage={photoImage}
>
  <Header
    name={headerData.name}
    title={headerData.title}
    subtitle={headerData.subtitle}
    paragraph={headerData.bio}
    photo={headerData.portrait || photoImage}
    linkedinUrl={staticData.header.socials.linkedin}
    githubUrl={staticData.header.socials.github}
    cvUrl={homePageContent?.cvUrl || "#"}
    downloadCvText={staticData.header.downloadCv}
  />

  <main
    class="p-5 flex flex-col justify-center items-center text-text-base overflow-x-hidden transition-colors"
    id="main-content"
  >
    <section
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-[1.25rem] max-w-[50rem] w-full mb-16 lg:self-center"
      aria-labelledby="skills-heading"
    >
      <h2 id="skills-heading" class="sr-only">{staticData.home.skillsTitle}</h2>
      {
        skillCategories.map((skillCategory: any, index: number) => {
          if (!skillCategory?.skills || !Array.isArray(skillCategory.skills))
            return null;
          const skillsForTicker = [
            ...skillCategory.skills,
            skillCategory.skills[0],
          ];
          return (
            <div class={`reveal delay-${(index + 1) * 100}`}>
              <SkillCard
                client:visible
                category={skillCategory.category}
                skills={skillsForTicker}
              />
            </div>
          );
        })
      }
    </section>

    {
      portfolioProjects.length > 0 && (
        <section
          class="flex flex-col justify-center items-center w-full max-w-[50rem] mb-16"
          aria-labelledby="projects-heading"
        >
          <div class="w-full mb-16 reveal">
            <h2
              id="projects-heading"
              class="text-[clamp(2.5rem,5vw,3.625rem)] font-display font-bold"
            >
              {staticData.home.projects.title}
            </h2>
            <p class="text-text-muted mt-2 font-sans">
              {staticData.home.projects.description}
            </p>
          </div>

          {PROJECT_CATEGORIES_ORDER.map((cat) => {
            const categoryProjects = projectsByCategory[cat] || [];
            if (categoryProjects.length === 0) return null;

            return (
              <div class="w-full mb-16 last:mb-0">
                <div class="flex items-center gap-4 mb-16 reveal">
                  <h3 class="text-2xl font-display font-bold text-text-base">
                    {CATEGORY_DISPLAY_NAMES[cat] || cat}
                  </h3>
                  <div class="h-[1px] flex-1 bg-border-base/30" />
                  <span class="text-[10px] font-mono text-text-base font-bold uppercase tracking-[0.2em]">
                    {categoryProjects.length}{" "}
                    {categoryProjects.length === 1
                      ? staticData.home.projects.projectCount
                      : staticData.home.projects.projectsCount}
                  </span>
                </div>

                <div
                  class={`${
                    categoryProjects.length === 1
                      ? "flex justify-center"
                      : "grid grid-cols-1 md:grid-cols-2"
                  } gap-[1.5rem] w-full items-start`}
                >
                  {categoryProjects.map((project: any, index: number) => (
                    <article
                      class={`reveal delay-${(index + 1) * 100} h-full ${
                        categoryProjects.length === 1 ? "w-full max-w-lg" : ""
                      }`}
                    >
                      <ProjectCard
                        title={project.title}
                        thumbnail={project.thumbnail}
                        technologies={project.technologies}
                        demoUrl={project.demoUrl}
                        codeUrl={project.codeUrl}
                      />
                    </article>
                  ))}
                </div>
              </div>
            );
          })}
        </section>
      )
    }

    {
      featuredBlogPosts.length > 0 && (
        <section
          class="flex flex-col justify-center items-center w-full max-w-[50rem] mb-16"
          aria-labelledby="blog-heading"
        >
          <div class="w-full flex justify-between items-center mb-16 reveal">
            <h2
              id="blog-heading"
              class="text-[clamp(2.8rem,5vw,3.625rem)] font-display font-bold text-left w-full"
            >
              {staticData.home.blog.title}
            </h2>
          </div>
          <div class="flex flex-col justify-center items-center gap-16 w-full">
            {featuredBlogPosts.map((post: BlogPost, index: number) => (
              <article class={`w-full reveal delay-${(index + 1) * 100}`}>
                <BlogCard
                  title={post.title}
                  excerpt={post.excerpt || ""}
                  slug={post.slug || ""}
                  coverImage={post.coverImage}
                />
              </article>
            ))}
            <div class="reveal delay-300">
              <a
                href="/blog"
                class="font-bold hover:text-link-hover transition-all mt-4"
              >
                {staticData.home.blog.viewAll}
              </a>
            </div>
          </div>
        </section>
      )
    }

    <section class="w-full reveal mb-16" aria-labelledby="contact-heading">
      <h2 id="contact-heading" class="sr-only">Contact Me</h2>
      <ContactForm client:visible email="connect@johandercampos.com" />
    </section>

    {
      frequentlyAskedQuestions.length > 0 && (
        <section
          class="text-center p-2 sm:p-5 w-full md:max-w-[45rem] font-display mt-0 mb-16"
          aria-labelledby="faq-heading"
        >
          <div class="reveal">
            <h2
              id="faq-heading"
              class="text-[clamp(2.5rem,5vw,3.625rem)] font-bold tracking-[0.0625rem] sm:tracking-[0.125rem]"
            >
              {staticData.home.faq.title}
            </h2>
          </div>
          <div class="reveal">
            <div class="glassmorphism p-4 sm:p-[1.875rem] rounded-[1.25rem] sm:rounded-[1.875rem] mt-16 transition-all duration-300 cursor-pointer">
              {frequentlyAskedQuestions.map((faq: any) => (
                <FaqItem
                  client:visible
                  question={faq.question}
                  answer={faq.answer}
                />
              ))}
            </div>
          </div>
        </section>
      )
    }
  </main>

  <Footer
    linkedinUrl={staticData.header.socials.linkedin}
    githubUrl={staticData.header.socials.github}
    repoUrl={staticData.header.repoUrl}
  />
</BaseLayout>
<script
  is:inline
  define:vars={{
    pageTitle,
    pageDescription,
    projectsByCategory,
    frequentlyAskedQuestions,
    combinedJsonLd,
    featuredBlogPosts,
  }}></script>
