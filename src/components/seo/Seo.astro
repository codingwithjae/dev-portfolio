---
import { getImage } from "astro:assets";

export interface Props {
    title: string;
    description: string;
    image?: string | undefined;
    type?: "website" | "article" | "profile" | undefined;
    jsonLd?: string | undefined;
    canonicalUrl?: string | undefined;
    noindex?: boolean | undefined;
    preloadHeroImage?: ImageMetadata | string | undefined;
    siteName?: string | undefined;
    siteUrl?: string | undefined;
}

const {
    title,
    description,
    image = "/favicon.webp",
    type = "website",
    jsonLd,
    canonicalUrl,
    noindex = false,
    preloadHeroImage,
    siteName = "Johander Campos",
    siteUrl,
} = Astro.props;

const resolvedSiteUrl =
    siteUrl || Astro.site?.href || "https://developer.johandercampos.com";
const fullCanonicalUrl = canonicalUrl || Astro.url.href;
const fullOgImage = image.startsWith("http")
    ? image
    : `${resolvedSiteUrl}${image}`;

let optimizedHeroUrl = "";
if (preloadHeroImage) {
    if (typeof preloadHeroImage === "string") {
        optimizedHeroUrl = preloadHeroImage;
    } else if (preloadHeroImage) {
        const optimizedHero = await getImage({
            src: preloadHeroImage,
            width: 375,
            format: "webp",
        });
        optimizedHeroUrl = optimizedHero.src;
    }
}
---

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>{title}</title>
<meta name="description" content={description} />
<meta name="robots" content={noindex ? "noindex, nofollow" : "index, follow"} />
<link rel="canonical" href={fullCanonicalUrl} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={fullOgImage} />
<meta property="og:url" content={fullCanonicalUrl} />
<meta property="og:type" content={type} />
<meta property="og:site_name" content={siteName} />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={fullOgImage} />
<link rel="icon" type="image/webp" href="/favicon.webp" />

{
    optimizedHeroUrl && (
        <link
            rel="preload"
            as="image"
            href={optimizedHeroUrl}
            type="image/webp"
            fetchpriority="high"
        />
    )
}

<link
    rel="preload"
    href="/fonts/inter-400.woff2"
    as="font"
    type="font/woff2"
    crossorigin
/>
<link
    rel="preload"
    href="/fonts/space-grotesk-700.woff2"
    as="font"
    type="font/woff2"
    crossorigin
/>

<link rel="preconnect" href="https://cdn.sanity.io" />

{jsonLd && <script is:inline type="application/ld+json" set:html={jsonLd} />}

<script is:inline>
    const getTheme = () => {
        if (
            typeof localStorage !== "undefined" &&
            localStorage.getItem("theme")
        ) {
            return localStorage.getItem("theme");
        }
        return "light";
    };

    const theme = getTheme();
    document.documentElement.setAttribute("data-theme", theme);
</script>
<script
    is:inline
    define:vars={{
        title,
        description,
        image,
        type,
        jsonLd,
        canonicalUrl,
        noindex,
        preloadHeroImage,
        siteName,
        siteUrl,
        fullCanonicalUrl,
        fullOgImage,
        optimizedHeroUrl,
    }}
>
    console.debug("SEO initialized");
</script>
